<!-- 
  This file is automatically imported by NuGet into a user's project
  when it targets a single framework, or in classic (pre 2017) csproj projects.
-->
<Project TreatAsLocalProperty="SciterCorePackFolderTaskFolder;SciterCorePackFolderTaskAssembly">

  <PropertyGroup>
    <SciterCorePackDirectory Condition=" '$(SciterCorePackDirectory)' == '' ">wwwroot</SciterCorePackDirectory>
    <SciterCorePackType Condition=" '$(SciterCorePackType)' == '' ">binary</SciterCorePackType>
    <SciterCorePackCopyToOutput Condition=" '$(SciterCorePackCopyToOutput)' == '' ">false</SciterCorePackCopyToOutput>
  </PropertyGroup>
  
  <PropertyGroup>
    <SciterCorePackFolderTaskFolder>$(MSBuildThisFileDirectory)..\..\scripts\</SciterCorePackFolderTaskFolder>
    <SciterCorePackFolderTaskAssembly Condition="$([MSBuild]::IsOsPlatform(Windows))">packfolder.exe</SciterCorePackFolderTaskAssembly>
    <SciterCorePackFolderTaskAssembly Condition="$([MSBuild]::IsOsPlatform(OSX))">packOSX.sh</SciterCorePackFolderTaskAssembly>
    <SciterCorePackFolderTaskAssembly Condition="$([MSBuild]::IsOsPlatform(Linux))">packOSX.sh</SciterCorePackFolderTaskAssembly>
  </PropertyGroup>
  
  <!-- Keeping the 'SciterCorePackType' condition here rather than making it a parameter for the 'Exec' command, makes things easier to manage! -->
  <Target Name="SciterCorePackFolderPreBuild" BeforeTargets="PreBuildEvent" Condition=" '$(SciterCorePackType)' == 'binary' ">
    <MakeDir Directories="$(ProjectDir).sciter" />
    <Exec Command="$(SciterCorePackFolderTaskFolder)$(SciterCorePackFolderTaskAssembly) &quot;$(ProjectDir)$(SciterCorePackDirectory)&quot; &quot;$(ProjectDir).sciter\$(ProjectName).bin&quot; -binary" />
  </Target>

  <!-- Add the binary created above to the Embedded Resources of the project -->
  <Target Name="SciterCorePackFolderEmbedLocal" BeforeTargets="PrepareForBuild" Condition=" '$(SciterCorePackType)' == 'binary' ">
    <ItemGroup>
      <EmbeddedResource Include="$(ProjectDir).sciter\$(ProjectName).bin">
        <LogicalName>SciterResource</LogicalName>
      </EmbeddedResource>
    </ItemGroup>
  </Target>

  <!-- Copies files from `SciterCorePackDirectory` to the Project `TargetDir` if `SciterCorePackCopyToOutput` == true -->
  <Target Name="SciterCorePackFolderPreBuildCopyOutput" BeforeTargets="AfterBuild" Condition=" '$(SciterCorePackCopyToOutput)' " >
    <ItemGroup>
      <SiteResources Include="$(ProjectDir)$(SciterCorePackDirectory)\**\*.*" />
    </ItemGroup>
    <Copy SourceFiles="@(SiteResources)" DestinationFolder="$(TargetDir)\$(SciterCorePackDirectory)\%(RecursiveDir)" SkipUnchangedFiles="true" />
  </Target>

  <!-- Always exclude the source directory -->
  <Target Name="SciterCorePackFolderExcludePackDirectory" >
    <ItemGroup>
      <None Include="$(SciterCorePackDirectory)\**" />
    </ItemGroup>
  </Target>
  
</Project>
